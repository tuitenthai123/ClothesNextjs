<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Temperature & Humidity Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }

        h2 {
            color: #333;
        }

        p {
            font-size: 20px;
        }

        button {
            font-size: 18px;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2>ESP32 Temperature & Humidity Monitor</h2>
    <p>Temperature: <span id="temperature">--</span> °C</p>
    <p>Humidity: <span id="humidity">--</span> %</p>

    <button onclick="controlLED('ON')">Turn LED ON</button>
    <button onclick="controlLED('OFF')">Turn LED OFF</button>

    <!-- Import Paho MQTT Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
        type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" type="text/javascript"></script>
    <script>
            var client; // Declare client globally for persistent connection
        
            $(document).ready(function() {
                connectToBroker(); 
        
                $('.bat').click(function(){
                message = new Paho.MQTT.Message("on");
                message.destinationName = "tuitenthai/conmeo/data";
                client.send(message);
            });
                function connectToBroker() {
                    client = new Paho.MQTT.Client("broker.emqx.io", Number(8083), "mqttx_9f08f604");
        
                    client.onConnectionLost = onConnectionLost;
                    client.onMessageArrived = onMessageArrived;
        
                    client.connect({onSuccess:onConnect});
                }
        
                function onConnect() {
                    console.log("Connected");
                    client.subscribe("esp32/led");
                    client.subscribe("esp32/temperature");
                    client.subscribe("esp32/humidity");
                }
        
                function onConnectionLost(responseObject) {
                    if (responseObject.errorCode !== 0) {
                        console.log("Connection lost:", responseObject.errorMessage);
                        // Optionally, attempt to reconnect here
                    }
                }
        
                function onMessageArrived(message) {
                    console.log("Received message from", message.destinationName);
                    console.log("Payload:", message.payloadString);
                    if(message.destinationName === "esp32/temperature"){
                        let t = document.getElementById("temperature")
                        t.innerHTML = message.payloadString
                    }
                    if(message.destinationName === "esp32/humidity"){
                        let h = document.getElementById("humidity")
                        h.innerHTML = message.payloadString
                    }
                    // let jsonstring = message.payloadString
                    // let paylot =jsonstring.split(",")
                    // let t = document.getElementById("nhietdo")
                    // let h = document.getElementById("doam")
                    // t.innerHTML=paylot[0]
                    // h.innerHTML=paylot[1]
        
                    // Process the received payload here (e.g., update UI, control LED)
                    // You can use the payload data to turn on/off the LED or perform other actions
                }
            });

            function controlLED(status) {
            const message = new Paho.MQTT.Message(status);
            message.destinationName = 'esp32/led';
            client.send(message);
            console.log(`Gửi lệnh LED: ${status}`);
        }
        </script>
</body>

</html>